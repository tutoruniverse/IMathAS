var MQeditor=function(y){var g={layoutstyle:"auto",layout:[]},q={},r=!1,h=null,l=null,p=null,b=MathQuill.getInterface(MathQuill.getInterface.MAX),w=["alpha","beta","chi","delta","epsilon","gamma","varphi","phi","psi","sigma","rho","theta","lambda","mu","nu","omega","tau"];function i(){try{return window.self!==window.top}catch(t){return!0}}function o(o,t,e){var a,s,n,r,l,i,c,d,m,u,h,p,f;if("string"==typeof o&&(o=document.getElementById(o)),a="boolean"==typeof t?t:"hidden"!=o.type,s=o.id,n=o.getAttribute("data-mq")||"",!0===a){if(r=y(o).attr("type","hidden").val(),g.hasOwnProperty("toMQ")&&(r=g.toMQ(r,s)),0==(l=y("#mqinput-"+s)).length){if(i=y("<span/>",{id:"mqinput-"+s,class:"mathquill-math-field",text:r,"aria-label":o.getAttribute("aria-label")}),null!==(c=o.className.match(/(ansred|ansyel|ansgrn|ansorg)/))&&i.addClass(c[0]),n.match(/chem/)&&i.addClass("mq-chem"),d=o.hasAttribute("size")?3<o.size?o.size/1.8:o.size:10,i.css("min-width",d+"em"),i.insertAfter(o),m={handlers:{edit:C,enter:k}},g.hasOwnProperty("getLayoutstyle")?g.curlayoutstyle=g.getLayoutstyle():"auto"==g.layoutstyle?g.curlayoutstyle=O():g.curlayoutstyle=g.layoutstyle,"OSK"==g.curlayoutstyle&&(m.substituteTextarea=function(){var t=document.createElement("span");return t.setAttribute("tabindex",0),t},m.keyboardPassthrough=!0),n.match(/chem/)&&(m.charsThatBreakOutOfSupSubVar="",m.charsThatBreakOutOfSupSubOp="",m.autoSubscriptNumerals=!0),n.match(/list/)&&(m.charsThatBreakOutOfSupSub="=<>,"),n.match(/allowplusminus/)&&(m.quickplusminus=!0),m.autoOperatorNames=m.autoParenOperators="ln log abs exp sin cos tan arcsinh arccosh arctanh arcsech arccsch arccoth argsinh argcosh argtanh argsech argcsch argcoth arsinh arcosh artanh arsech arcsch arcoth arcsin arccos arctan sec csc cot arcsec arccsc arccot sinh cosh sech csch tanh coth",m.autoCommands="pi theta root sqrt ^oo degree",n.match(/logic/)&&(m.autoCommands+=" neg xor or and implies iff"),n.match(/setexp/)&&(m.autoCommands+=" nn xor uu ominus cap cup oplus"),""!=(u=o.getAttribute("data-mq-vars")||""))for(u=""==u?[]:u.split(/,/),p=0;p<u.length;p++)for(h=u[p].split(/_/),f=0;f<h.length;f++)1<h[f].length&&h[f].match(/^[a-zA-Z]+$/)&&(-1!=w.indexOf(h[f].toLowerCase())?m.autoCommands+=" "+h[f]:m.autoOperatorNames+=" "+h[f]);o.disabled?(l=b.StaticMath(i[0]),i.addClass("disabled")):(l=b.MathField(i[0],m).config(q),console.log({thisMQconfig:m,MQconfig:q}),v(i),y(o).on("change.mqed",function(t,e){if(console.log("val",t.value),!e){var a=o.value;g.hasOwnProperty("toMQ")&&(a=g.toMQ(a,o.id)),console.log("val",a),l.latex(a)}}))}else l.show(),l=b(l[0]).latex(r);!0!==e&&l.focus()}else y(o).attr("type","text").off("change.mqed"),!0!==e&&y(o).focus(),y("#mqinput-"+s).hide()}function v(t){y(t).find(".mq-textarea > *").on("focus.mqeditor",e).on("blur.mqeditor",function(){l=setTimeout(a,100),g.hasOwnProperty("onBlur")&&g.onBlur()}),y(t).on("click.mqeditor",function(t){var e=y(t.target).closest("label");if(0<e.length)return"undefined"!==e.attr("for")&&y("#"+e.attr("for")).prop("checked",!0),t.stopPropagation(),!1})}function e(t){var a,e,o,s,n;clearTimeout(l),a=y(t.target).closest(".mathquill-math-field"),!1===r&&(y("body").append(y("<div/>",{id:"mqeditor",class:"mqeditor"})),y("#mqeditor").on("mousedown touchstart",function(t){t.preventDefault()}),r=!0),e=g.curlayoutstyle,g.hasOwnProperty("getLayoutstyle")?g.curlayoutstyle=g.getLayoutstyle():"auto"==g.layoutstyle?g.curlayoutstyle=O():g.curlayoutstyle=g.layoutstyle,"OSK"===g.curlayoutstyle?(i()?y("#mqeditor").addClass("iframeosk").removeClass("fixedbottom"):y("#mqeditor").addClass("fixedbottom").removeClass("iframeosk"),document.getElementById("mqe-fb-spacer")||((o=document.createElement("div")).style.height="200px",o.id="mqe-fb-spacer",y("body").append(o))):y("#mqeditor").removeClass("fixedbottom iframeosk"),y("#mqeditor").toggleClass("mq-chem",y(a).hasClass("mq-chem")),s=!1,null!==h&&a[0]==h.el()&&e===g.curlayoutstyle||(s=!0,null!==h&&y("#"+h.el().id.substring(8)).trigger("change",!0),g.hasOwnProperty("getLayout")&&(g.layout=g.getLayout(a[0],g.curlayoutstyle)),y("#mqeditor").empty().show(),g.layout.tabs?function(t,e,a){var o,s,n,r,l,i=document.createElement("div");i.className="mqed-row mqed-tabrow";o=document.createElement("div"),0;t.appendChild(i),t.appendChild(o);for(r=0;r<e.tabs.length;r++)if(!0===e.tabs[r].enabled)for(0,f(i,e.tabs[r],a+"-"+r),(n=document.createElement("div")).className="mqed-row mqed-tabpanel",n.id=a+"-"+r+"-tabpanel",o.appendChild(n),l=0;l<e.tabs[r].tabcontent.length;l++)(s=e.tabs[r].tabcontent[l]).hasOwnProperty("flow")&&0==s.contents.length||(s.hasOwnProperty("flow")?u(n,s,a+"-"+r+"-"+l):f(n,s,a+"-"+r+"-"+l));f(i,{s:1}),f(i,{p:"&times;",c:"close",lb:"close"}),y(t).find(".mqed-tab").first().addClass("mqed-activetab")}(document.getElementById("mqeditor"),g.layout,"mqeditor"):u(document.getElementById("mqeditor"),g.layout,"mqeditor"),y("#mqeditor .mqed-btn.rend").each(function(){b.StaticMath(this,{mouseEvents:!1})}),0<y("#mqeditor .mqed-tabrow").length&&(y("#mqeditor .mqed-tabpanel").hide().first().show(),(n=y("#mqeditor .mqed-tabrow + div")).css("height",n.height()))),"OSK"!==g.curlayoutstyle||i()?y("#mqeditor").show():y("#mqeditor").slideDown(50,function(){var t=y("#mqeditor").height()+5,e=y(window).height()-(a.offset().top+a.outerHeight()-y(window).scrollTop());e<t&&y(window).scrollTop(y(window).scrollTop()+(t-e))}),c(a),h=b.MathField(a[0]),y("#"+a[0].id.substring(8)).triggerHandler("focus"),g.hasOwnProperty("onShow")&&g.onShow(a[0],g.curlayoutstyle,s),y(document).trigger("mqeditor:show")}function a(t){h&&(y(document).trigger("mqeditor:hide"),"OSK"!==g.curlayoutstyle||i()?y("#mqeditor").hide():y("#mqeditor").slideUp(50),y("#"+h.el().id.substring(8)).trigger("change",!0),h=null)}function c(t){var e,a,o,s,n;"under"==g.curlayoutstyle||i()?(a=(e=y(t).closest(".mathquill-math-field")).offset(),o=e.outerHeight(),s=a.left,document.getElementById("mqeditor")&&s+(n=document.getElementById("mqeditor").offsetWidth)>document.documentElement.clientWidth&&(s=document.documentElement.clientWidth-n-5),i()?y("#mqeditor").css("top",a.top+o+3).css("left",0):y("#mqeditor").css("top",a.top+o+3).css("left",s)):y("#mqeditor").css("top","auto").css("left",0)}function C(t){var e,a=t.el();console.log(a.id,q),c(a),g.hasOwnProperty("onResize")&&g.onResize(a,g.curlayoutstyle),a.id.match(/mqinput/)&&(e=t.latex(),g.hasOwnProperty("fromMQ")&&(console.log("pre latex",e),e=g.fromMQ(e,a.id)),console.log("post latex",e),y("#"+a.id.substring(8)).val(e).trigger("input"),""!=e&&y("#"+a.id.substring(8)).siblings("input[id^=qs][value=spec]").prop("checked",!0),g.hasOwnProperty("onEdit")&&g.onEdit(a.id,e))}function k(t){g.hasOwnProperty("onEnter")&&g.onEnter(t.el().id)}function O(){var t=document.documentElement.clientWidth;return navigator.userAgent.match(/Android/)||navigator.userAgent.match(/iPhone/)||navigator.userAgent.match(/iPad/)||t<500?"OSK":"under"}function u(t,e,a){var o,s,n,r,l,i,c=e.flow,d=100;for(e.hasOwnProperty("s")&&"row"==c&&(d=e.s),o=document.createElement("div"),e.hasOwnProperty("s")&&(o.style.flexGrow=e.s),e.hasOwnProperty("class")&&(o.className=e.class),e.hasOwnProperty("tabpanel")&&(o.id=e.tabpanel.id,o.style.display=e.tabpanel.hidden?"none":""),(s=document.createElement("div")).className="mqed-"+c,i=l=n=0;i<e.contents.length;i++)(r=e.contents[i]).hasOwnProperty("flow")&&0==r.contents.length||(d<n+(l=r.hasOwnProperty("s")?r.s:1)&&(o.appendChild(s),n=0,(s=document.createElement("div")).className="mqed-"+c),r.hasOwnProperty("flow")?u(s,r,a+"-"+i):f(s,r,a+"-"+i),n+=l);o.appendChild(s),t.appendChild(o)}function f(t,e,a){var o,s,n,r,l,i,c=document.createElement("div");(c.className="mqed-btn-cont",e.s&&(c.style.flexGrow=e.s),e.contid&&(c.id=e.contid),e.contclass&&y(c).addClass(e.contclass),t.appendChild(c),e.l||e.b||e.p)&&((o=document.createElement("span")).tabIndex=0,e.l?(e.op?(o.className="mqed-btn mq-math-mode",o.innerHTML='<span class="mq-root-block"><var class="mq-operator-name">'+e.l.substring(1)+"</var></span>"):e.pr?(o.className="mqed-btn mq-math-mode",o.innerHTML='<span class="mq-root-block">'+e.pr+"</span>"):e.l.match(/\\left(.)\\right(.)/)?(r=e.l.match(/\\left(.)\\right(.)/),o.className="mqed-btn mq-math-mode",o.innerHTML='<span class="mq-non-leaf"><span class="mq-scaled mq-paren" style="transform: scale(1, 1.2);">'+r[1]+'</span><span class="mq-non-leaf mq-empty"></span><span class="mq-scaled mq-paren" style="transform: scale(1, 1.2);">'+r[2]+"</span></span>"):(o.className="mqed-btn rend",o.innerText=e.l),s="c",n=e.l.substring(1)):e.b?(e.r?(o.className="mqed-btn rend",o.innerHTML=e.b):(o.className="mqed-btn mq-math-mode",e.v?o.innerHTML='<span class="mq-root-block"><var>'+e.b+"</var></span>":o.innerHTML='<span class="mq-root-block"><span>'+e.b+"</span></span>"),s="t",((n=e.b).match(/^\d$/)||"."==n)&&y(o).addClass("mqed-digitkey")):(o.className="mqed-btn",o.innerHTML=e.p,s="t",n=e.p),e.c&&("shift"==(s=e.c)?y(o).addClass("mqed-shift"):"k"==s?y(o).addClass("mqed-navkey"):"close"==s&&y(o).addClass("mqed-closebtn")),e.lb&&o.setAttribute("aria-label",e.lb),e.sm&&(o.style.fontSize=100-10*e.sm+"%"),e.w&&(n=e.w),e.tabcontent&&(y(o).addClass("mqed-tab"),s="showtabpanel",n=a+"-tabpanel"),y(o).data("cmdtype",s).data("cmdval",n),y(o).on("click mousedown touchstart keydown",(l=s,i=n,function(t){!function t(e,a,o){var s,n,r,l,i,c,d,u;if(("mousedown"!=e.type||"Backspace"===o)&&!("click"==e.type&&"Backspace"===o||"keydown"==e.type&&"Enter"!==e.key))if("touchstart"==e.type&&(e.preventDefault(),y(e.currentTarget).addClass("mactive")),"t"==a)o.match(/^[a-zA-Z]$/)&&y(e.target).closest(".mqed-tabpanel").find(".mqed-shift").hasClass("active")&&(o=o.toUpperCase()),h.typedText(o);else if("c"==a)h.cmd(o);else if("l"==a)h.latex(o);else if("w"==a){if(h.write(o),m=o.match(/bmatrix}(.*?)(\\\\|\\end{bm)/))for(s=m[1].split(/&/).length,n=0;n<s;n++)h.keystroke("Left")}else"k"==a?(h.keystroke(o),"Backspace"===o&&(p=setTimeout(function(){t(e,a,o)},null===p?600:70))):"m"==a?h.matrixCmd(o):"f"==a?(r=h.getSelection())?(h.write(o+"\\left("+r+"\\right)"),h.keystroke("Left")):o.match(/{}$/)?h.typedText(o.replace(/{}$/,"")):h.write(o):"sf"==a?((r=h.getSelection())?h.write(o+"{"+r+"}"):h.cmd(o),h.keystroke("Left")):"i"==a?((r=h.getSelection())||(r=""),"string"==typeof o?(l=o.charAt(0),i=o.charAt(1),h.write("\\left"+l+r+"\\right"+i)):h.write(o[0]+r+o[1]),""==r&&h.keystroke("Left")):"showtabpanel"==a?((c=y(e.target).closest(".mqed-btn")).closest(".mqeditor").find(".mqed-tabpanel").hide(),c.closest(".mqeditor").find(".mqed-btn.mqed-activetab").removeClass("mqed-activetab"),y("#"+o).show(),c.addClass("mqed-activetab"),g.hasOwnProperty("onTab")&&g.onTab(c[0],g.curlayoutstyle,o)):"shift"==a?(c=y(e.target).closest(".mqed-btn"),d=y(e.target).closest(".mqed-tabpanel"),(u=!c.hasClass("active"))?c.addClass("active"):c.removeClass("active"),d.find(".mqed-btn").each(function(t,e){var a=e.textContent;a.match(/^[a-zA-Z]$/)&&(e.textContent=u?e.textContent.toUpperCase():e.textContent.toLowerCase())})):"close"==a&&h.blur()}(t,l,i)})).on("touchend",function(t){setTimeout(function(){y(t.currentTarget).removeClass("mactive")},50)}).on("touchend mouseup",function(){clearTimeout(p),p=null}),c.appendChild(o))}return{setConfig:function(t){for(var e in t)g[e]=t[e]},setMQconfig:function(t){q=t},toggleMQ:o,toggleMQAll:function(t,e){var a=e||null;y(t).each(function(t,e){o(e,a,!0)})},attachEditor:v,getLayoutstyle:O,resetEditor:function(){clearTimeout(l),y("#mqeditor").hide(),h=null}}}(jQuery);
